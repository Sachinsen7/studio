<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Team Lead Functionality</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button.success {
            background: #28a745;
        }
        button.warning {
            background: #ffc107;
            color: #212529;
        }
        button.danger {
            background: #dc3545;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        input, select, textarea {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .form-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .team-lead-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 5px 0;
        }
        .project-badge {
            display: inline-block;
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
        }
        .product-badge {
            background: #d1ecf1;
            color: #0c5460;
        }
        .project-badge-default {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Team Lead & Project Type Management</h1>
        <p>Test the new team lead functionality and project categories (Product vs Project).</p>

        <div class="grid">
            <!-- Left Column -->
            <div>
                <!-- Schema Migration -->
                <div class="section">
                    <h3>1. Schema Migration</h3>
                    <p>Run this first to migrate existing data to support multiple team leads and new project types.</p>
                    <button class="warning" onclick="runSchemaMigration()">Run Schema Migration</button>
                    <div id="migration-result" class="result"></div>
                </div>

                <!-- List Employees -->
                <div class="section">
                    <h3>2. List Employees</h3>
                    <button onclick="listEmployees()">Get All Employees</button>
                    <div id="employees-result" class="result"></div>
                </div>

                <!-- Team Lead Assignment -->
                <div class="section">
                    <h3>3. Assign Team Lead</h3>
                    <div class="form-group">
                        <div class="form-row">
                            <input type="text" id="employee-id" placeholder="Employee ID" style="width: 200px;">
                            <button onclick="loadEmployeeForTeamLead()">Load Employee</button>
                        </div>
                        <div class="form-row">
                            <input type="text" id="team-lead-projects" placeholder="Project Names (comma-separated)" style="width: 300px;">
                            <select id="team-lead-action" style="width: 100px;">
                                <option value="add">Add</option>
                                <option value="remove">Remove</option>
                                <option value="replace">Replace</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <button class="success" onclick="assignTeamLead()">Update Team Lead Assignment</button>
                            <button onclick="getTeamLeadAssignments()">Get Current Assignments</button>
                        </div>
                    </div>
                    <div id="team-lead-result" class="result"></div>
                </div>

                <!-- Create Project with Type -->
                <div class="section">
                    <h3>4. Create Project with Type</h3>
                    <div class="form-group">
                        <div class="form-row">
                            <input type="text" id="new-project-name" placeholder="Project Name" style="width: 200px;">
                            <input type="text" id="new-project-client" placeholder="Client Name" style="width: 200px;">
                        </div>
                        <div class="form-row">
                            <select id="new-project-type" style="width: 150px;">
                                <option value="Project">Project</option>
                                <option value="Product">Product</option>
                            </select>
                            <select id="new-project-status" style="width: 150px;">
                                <option value="OnTrack">On Track</option>
                                <option value="AtRisk">At Risk</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <textarea id="new-project-description" placeholder="Project Description" rows="2" style="width: 400px;"></textarea>
                        </div>
                    </div>
                    <button class="success" onclick="createProjectWithType()">Create Project</button>
                    <div id="create-project-result" class="result"></div>
                </div>
            </div>

            <!-- Right Column -->
            <div>
                <!-- List Projects with Types -->
                <div class="section">
                    <h3>5. List Projects with Types</h3>
                    <button onclick="listProjectsWithTypes()">Get All Projects</button>
                    <div id="projects-types-result" class="result"></div>
                </div>

                <!-- Team Leads Overview -->
                <div class="section">
                    <h3>6. Team Leads Overview</h3>
                    <button onclick="getTeamLeadsOverview()">Get All Team Leads</button>
                    <button onclick="getTeamLeadsForProject()">Get Team Leads for Project</button>
                    <input type="text" id="project-name-filter" placeholder="Project Name" style="width: 200px;">
                    <div id="team-leads-overview-result" class="result"></div>
                </div>

                <!-- Project Statistics -->
                <div class="section">
                    <h3>7. Project Statistics</h3>
                    <button onclick="getProjectStatistics()">Get Statistics</button>
                    <div id="statistics-result" class="result"></div>
                </div>

                <!-- Test Scenarios -->
                <div class="section">
                    <h3>8. Test Scenarios</h3>
                    <button onclick="testMultipleTeamLeadScenario()">Test: One Person, Multiple Projects</button>
                    <button onclick="testProjectTypeScenario()">Test: Product vs Project Types</button>
                    <div id="test-scenarios-result" class="result"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                return { success: response.ok, data, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        function displayResult(elementId, result) {
            const resultDiv = document.getElementById(elementId);
            if (result.success) {
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(result.data, null, 2);
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = `Error (${result.status || 'Network'}): ${result.error || JSON.stringify(result.data, null, 2)}`;
            }
        }

        async function runSchemaMigration() {
            const result = await makeRequest('/api/admin/update-team-lead-schema', { method: 'POST' });
            displayResult('migration-result', result);
        }

        async function listEmployees() {
            const result = await makeRequest('/api/employees');
            displayResult('employees-result', result);
            
            // Auto-fill first employee ID
            if (result.success && Array.isArray(result.data) && result.data.length > 0) {
                document.getElementById('employee-id').value = result.data[0].id;
            }
        }

        async function loadEmployeeForTeamLead() {
            const employeeId = document.getElementById('employee-id').value.trim();
            if (!employeeId) {
                alert('Please enter an employee ID');
                return;
            }

            const result = await makeRequest(`/api/employees/${employeeId}/assign-team-lead`);
            displayResult('team-lead-result', result);
        }

        async function assignTeamLead() {
            const employeeId = document.getElementById('employee-id').value.trim();
            const projectNames = document.getElementById('team-lead-projects').value.trim().split(',').map(p => p.trim()).filter(p => p);
            const action = document.getElementById('team-lead-action').value;

            if (!employeeId || projectNames.length === 0) {
                alert('Please enter employee ID and project names');
                return;
            }

            const result = await makeRequest(`/api/employees/${employeeId}/assign-team-lead`, {
                method: 'POST',
                body: JSON.stringify({ projectNames, action })
            });
            displayResult('team-lead-result', result);
        }

        async function getTeamLeadAssignments() {
            const employeeId = document.getElementById('employee-id').value.trim();
            if (!employeeId) {
                alert('Please enter an employee ID');
                return;
            }

            const result = await makeRequest(`/api/employees/${employeeId}/assign-team-lead`);
            displayResult('team-lead-result', result);
        }

        async function createProjectWithType() {
            const projectData = {
                name: document.getElementById('new-project-name').value.trim(),
                clientName: document.getElementById('new-project-client').value.trim(),
                projectType: document.getElementById('new-project-type').value,
                status: document.getElementById('new-project-status').value,
                description: document.getElementById('new-project-description').value.trim(),
            };

            if (!projectData.name) {
                alert('Project name is required');
                return;
            }

            const result = await makeRequest('/api/projects', {
                method: 'POST',
                body: JSON.stringify(projectData)
            });
            displayResult('create-project-result', result);

            if (result.success) {
                // Clear form
                document.getElementById('new-project-name').value = '';
                document.getElementById('new-project-client').value = '';
                document.getElementById('new-project-description').value = '';
            }
        }

        async function listProjectsWithTypes() {
            const result = await makeRequest('/api/projects');
            displayResult('projects-types-result', result);
        }

        async function getTeamLeadsOverview() {
            const result = await makeRequest('/api/projects/team-leads');
            displayResult('team-leads-overview-result', result);
        }

        async function getTeamLeadsForProject() {
            const projectName = document.getElementById('project-name-filter').value.trim();
            if (!projectName) {
                alert('Please enter a project name');
                return;
            }

            const result = await makeRequest(`/api/projects/team-leads?projectName=${encodeURIComponent(projectName)}`);
            displayResult('team-leads-overview-result', result);
        }

        async function getProjectStatistics() {
            const projectsResult = await makeRequest('/api/projects');
            const teamLeadsResult = await makeRequest('/api/projects/team-leads');

            if (projectsResult.success && teamLeadsResult.success) {
                const projects = projectsResult.data;
                const teamLeads = teamLeadsResult.data.teamLeads;

                const stats = {
                    totalProjects: projects.length,
                    productCount: projects.filter(p => p.projectType === 'Product').length,
                    projectCount: projects.filter(p => p.projectType === 'Project').length,
                    totalTeamLeads: teamLeads.length,
                    teamLeadsWithMultipleProjects: teamLeads.filter(tl => tl.projectCount > 1).length,
                    averageProjectsPerTeamLead: teamLeads.length > 0 ? (teamLeads.reduce((sum, tl) => sum + tl.projectCount, 0) / teamLeads.length).toFixed(2) : 0,
                    projectsByStatus: {
                        OnTrack: projects.filter(p => p.status === 'OnTrack').length,
                        AtRisk: projects.filter(p => p.status === 'AtRisk').length,
                        Completed: projects.filter(p => p.status === 'Completed').length,
                    }
                };

                displayResult('statistics-result', { success: true, data: stats });
            } else {
                displayResult('statistics-result', { success: false, error: 'Failed to fetch statistics' });
            }
        }

        async function testMultipleTeamLeadScenario() {
            // This will test assigning one person as team lead to multiple projects
            const result = await makeRequest('/api/employees');
            if (result.success && result.data.length > 0) {
                const firstEmployee = result.data[0];
                
                // Create test projects
                const testProjects = ['Test Project A', 'Test Project B', 'Test Project C'];
                
                for (const projectName of testProjects) {
                    await makeRequest('/api/projects', {
                        method: 'POST',
                        body: JSON.stringify({
                            name: projectName,
                            projectType: 'Project',
                            status: 'OnTrack',
                            description: `Test project for multiple team lead scenario`
                        })
                    });
                }

                // Assign employee as team lead to all test projects
                const assignResult = await makeRequest(`/api/employees/${firstEmployee.id}/assign-team-lead`, {
                    method: 'POST',
                    body: JSON.stringify({
                        projectNames: testProjects,
                        action: 'replace'
                    })
                });

                displayResult('test-scenarios-result', assignResult);
            }
        }

        async function testProjectTypeScenario() {
            // Create projects of different types
            const testData = [
                { name: 'E-commerce Platform', type: 'Product', client: 'Tech Corp' },
                { name: 'Website Redesign', type: 'Project', client: 'Design Agency' },
                { name: 'Mobile App', type: 'Product', client: 'Startup Inc' },
                { name: 'Database Migration', type: 'Project', client: 'Enterprise Ltd' }
            ];

            const results = [];
            for (const project of testData) {
                const result = await makeRequest('/api/projects', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: project.name,
                        clientName: project.client,
                        projectType: project.type,
                        status: 'OnTrack',
                        description: `Test ${project.type.toLowerCase()} for type categorization`
                    })
                });
                results.push({ project: project.name, success: result.success });
            }

            displayResult('test-scenarios-result', { success: true, data: { message: 'Project type test completed', results } });
        }

        // Auto-load data on page load
        window.onload = function() {
            listEmployees();
            listProjectsWithTypes();
        };
    </script>
</body>
</html>